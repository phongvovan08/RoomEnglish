<!DOCTYPE html>
<html>
<head>
    <title>Test OpenAI TTS Direct</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>ğŸ§ª Testing OpenAI TTS API Direct</h1>
    <p>Má»Ÿ Console (F12) Ä‘á»ƒ xem káº¿t quáº£ test...</p>
    
    <div id="status">ğŸ”„ Testing...</div>
    <button onclick="runTest()" id="testBtn">Run Test Again</button>
    
    <script>
        // Test trá»±c tiáº¿p OpenAI TTS API
        async function testOpenAIDirectly() {
          const apiKey = 'sk-proj-xxxx';
          console.log('ğŸ§ª Testing OpenAI API directly...')
          document.getElementById('status').textContent = 'ğŸ”„ Testing OpenAI API...'
          
          try {
            const response = await fetch('https://api.openai.com/v1/audio/speech', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'tts-1',
                input: 'Hello! This is a test of OpenAI TTS from RoomEnglish application.',
                voice: 'alloy'
              })
            })
            
            console.log('ğŸ“¡ Response:', {
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries(response.headers.entries())
            })
            
            if (response.ok) {
              const audioBuffer = await response.arrayBuffer()
              console.log('âœ… Success! Audio buffer size:', audioBuffer.byteLength, 'bytes')
              document.getElementById('status').textContent = 'âœ… SUCCESS! Playing audio...'
              
              // Test play audio
              const blob = new Blob([audioBuffer], { type: 'audio/mp3' })
              const audioUrl = URL.createObjectURL(blob)
              const audio = new Audio(audioUrl)
              
              audio.onloadeddata = () => {
                console.log('ğŸµ Audio loaded, duration:', audio.duration, 'seconds')
              }
              
              audio.onplay = () => {
                console.log('â–¶ï¸ Playing audio...')
              }
              
              audio.onended = () => {
                console.log('â¹ï¸ Audio finished')
                document.getElementById('status').textContent = 'â¹ï¸ Audio finished successfully!'
                URL.revokeObjectURL(audioUrl)
              }
              
              audio.onerror = (e) => {
                console.error('âŒ Audio play error:', e)
                document.getElementById('status').textContent = 'âŒ Audio play failed!'
              }
              
              await audio.play()
              return true
              
            } else {
              const errorText = await response.text()
              console.error('âŒ API Error:', {
                status: response.status,
                statusText: response.statusText,
                body: errorText
              })
              
              // Special handling for 429 error
              if (response.status === 429) {
                document.getElementById('status').innerHTML = `
                  <div style="color: orange;">
                    <strong>âš ï¸ Rate Limited (429)</strong><br/>
                    CÃ³ thá»ƒ do:<br/>
                    â€¢ API key chÆ°a cÃ³ billing setup<br/>
                    â€¢ VÆ°á»£t quÃ¡ quota miá»…n phÃ­<br/>
                    â€¢ Gá»i API quÃ¡ nhanh<br/>
                    <small>Chi tiáº¿t: ${errorText}</small>
                  </div>
                `
              } else {
                document.getElementById('status').textContent = `âŒ API Error: ${response.status} - ${response.statusText}`
              }
              
              // Parse error if JSON
              try {
                const errorJson = JSON.parse(errorText)
                console.error('ğŸ“‹ Error details:', errorJson)
              } catch (e) {
                console.log('ğŸ“ Error text:', errorText)
              }
              
              return false
            }
            
          } catch (error) {
            console.error('âŒ Network/Fetch Error:', error)
            document.getElementById('status').textContent = `âŒ Network Error: ${error.message}`
            return false
          }
        }

        function runTest() {
          testOpenAIDirectly().then(result => {
            console.log('ğŸ Test completed:', result ? 'SUCCESS' : 'FAILED')
          }).catch(error => {
            console.error('ğŸ’¥ Test crashed:', error)
            document.getElementById('status').textContent = `ğŸ’¥ Test crashed: ${error.message}`
          })
        }

        // Auto-run test on page load
        document.addEventListener('DOMContentLoaded', () => {
          console.log('ğŸš€ Starting OpenAI API test...')
          runTest()
        })
    </script>
</body>
</html>