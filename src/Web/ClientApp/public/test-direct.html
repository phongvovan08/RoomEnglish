<!DOCTYPE html>
<html>
<head>
    <title>Test OpenAI TTS Direct</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>🧪 Testing OpenAI TTS API Direct</h1>
    <p>Mở Console (F12) để xem kết quả test...</p>
    
    <div id="status">🔄 Testing...</div>
    <button onclick="runTest()" id="testBtn">Run Test Again</button>
    
    <script>
        // Test trực tiếp OpenAI TTS API
        async function testOpenAIDirectly() {
          const apiKey = 'sk-proj-xxxx';
          console.log('🧪 Testing OpenAI API directly...')
          document.getElementById('status').textContent = '🔄 Testing OpenAI API...'
          
          try {
            const response = await fetch('https://api.openai.com/v1/audio/speech', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'tts-1',
                input: 'Hello! This is a test of OpenAI TTS from RoomEnglish application.',
                voice: 'alloy'
              })
            })
            
            console.log('📡 Response:', {
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries(response.headers.entries())
            })
            
            if (response.ok) {
              const audioBuffer = await response.arrayBuffer()
              console.log('✅ Success! Audio buffer size:', audioBuffer.byteLength, 'bytes')
              document.getElementById('status').textContent = '✅ SUCCESS! Playing audio...'
              
              // Test play audio
              const blob = new Blob([audioBuffer], { type: 'audio/mp3' })
              const audioUrl = URL.createObjectURL(blob)
              const audio = new Audio(audioUrl)
              
              audio.onloadeddata = () => {
                console.log('🎵 Audio loaded, duration:', audio.duration, 'seconds')
              }
              
              audio.onplay = () => {
                console.log('▶️ Playing audio...')
              }
              
              audio.onended = () => {
                console.log('⏹️ Audio finished')
                document.getElementById('status').textContent = '⏹️ Audio finished successfully!'
                URL.revokeObjectURL(audioUrl)
              }
              
              audio.onerror = (e) => {
                console.error('❌ Audio play error:', e)
                document.getElementById('status').textContent = '❌ Audio play failed!'
              }
              
              await audio.play()
              return true
              
            } else {
              const errorText = await response.text()
              console.error('❌ API Error:', {
                status: response.status,
                statusText: response.statusText,
                body: errorText
              })
              
              // Special handling for 429 error
              if (response.status === 429) {
                document.getElementById('status').innerHTML = `
                  <div style="color: orange;">
                    <strong>⚠️ Rate Limited (429)</strong><br/>
                    Có thể do:<br/>
                    • API key chưa có billing setup<br/>
                    • Vượt quá quota miễn phí<br/>
                    • Gọi API quá nhanh<br/>
                    <small>Chi tiết: ${errorText}</small>
                  </div>
                `
              } else {
                document.getElementById('status').textContent = `❌ API Error: ${response.status} - ${response.statusText}`
              }
              
              // Parse error if JSON
              try {
                const errorJson = JSON.parse(errorText)
                console.error('📋 Error details:', errorJson)
              } catch (e) {
                console.log('📝 Error text:', errorText)
              }
              
              return false
            }
            
          } catch (error) {
            console.error('❌ Network/Fetch Error:', error)
            document.getElementById('status').textContent = `❌ Network Error: ${error.message}`
            return false
          }
        }

        function runTest() {
          testOpenAIDirectly().then(result => {
            console.log('🏁 Test completed:', result ? 'SUCCESS' : 'FAILED')
          }).catch(error => {
            console.error('💥 Test crashed:', error)
            document.getElementById('status').textContent = `💥 Test crashed: ${error.message}`
          })
        }

        // Auto-run test on page load
        document.addEventListener('DOMContentLoaded', () => {
          console.log('🚀 Starting OpenAI API test...')
          runTest()
        })
    </script>
</body>
</html>